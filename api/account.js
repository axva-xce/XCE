import { readAccount, writeAccount, findAccount } from "./db.js"; export async function upsertAccount({ username, sub, email }) { if (!username) throw new Error("No username passed to upsertAccount"); let acct = await readAccount(username); if (!acct) { let emailToSave = email || ""; if (email) { const existingUserWithEmail = await findAccount(a => a.email === email); if (existingUserWithEmail) { console.warn(`[upsertAccount] Email '${email}' from Stripe is already in use by user '${existingUserWithEmail.username}'. The new user '${username}' will have a blank email.`); emailToSave = "" } } console.warn(`[upsertAccount] User '${username}' not found. Creating new stub account.`); acct = { username, passwordHash: "", email: emailToSave, tier: "T1", status: "free", stripeSubscriptionId: null, currentPeriodEnd: 0 } } const item = sub.items?.data?.[0]; acct.stripeSubscriptionId = sub.id; acct.tier = tierFromPrice(item?.price ?? {}); acct.currentPeriodEnd = sub.current_period_end ?? item?.current_period_end ?? 0; acct.status = acct.tier === "T1" ? "free" : "active"; await writeAccount(acct); return acct } function tierFromPrice(price) { switch (price.id) { case process.env.PRICE_ID_T2: return "T2"; case process.env.PRICE_ID_T3: return "T3"; default: return "T1" } }