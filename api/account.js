import { readAccount, writeAccount } from "./db.js"; export async function upsertAccount({ username, sub }) { if (!username) throw new Error("No username passed to upsertAccount"); let acct = await readAccount(username); if (!acct) { console.error(`[upsertAccount] CRITICAL: Received subscription for non-existent user: ${username}`); throw new Error(`Subscription received for non-existent user: ${username}`) } const item = sub.items?.data?.[0]; acct.stripeSubscriptionId = sub.id; acct.tier = tierFromPrice(item?.price ?? {}); acct.currentPeriodEnd = sub.current_period_end ?? 0; acct.status = acct.tier === "T1" ? "free" : "active"; await writeAccount(acct); return acct } function tierFromPrice(price) { switch (price.id) { case process.env.PRICE_ID_T2: return "T2"; case process.env.PRICE_ID_T3: return "T3"; default: return "T1" } }